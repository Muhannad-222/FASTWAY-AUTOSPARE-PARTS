<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FastWay Inventory: POS Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- Option 2: Soft Clay/Neumorphism Aesthetic --- */
        :root {
            --bg-primary: #E0E0E0; 
            --accent-yellow: #FFC000; 
            --accent-orange: #FF6A00; 
            --text-dark: #374151; 
            --text-subtle: #9CA3AF;
            
            --shadow-light: #ffffff; 
            --shadow-dark: #b0b0b0; 
            
            --neumo-elevated: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            --neumo-pressed: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        body { 
            background-color: var(--bg-primary); 
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            transition: background-color 0.3s;
        }

        /* --- Neumorphism Base Styles --- */
        .neumo-panel {
            background-color: var(--bg-primary);
            border-radius: 2.5rem;
            box-shadow: var(--neumo-elevated);
            padding: 2rem;
            transition: all 0.2s ease-in-out;
        }

        .neumo-btn {
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            border-radius: 9999px;
            padding: 0.75rem 1.5rem;
            border: none;
            letter-spacing: 0.01em;
            cursor: pointer;
            background-color: var(--bg-primary); 
            box-shadow: var(--neumo-elevated);
        }
        
        .neumo-btn:hover {
            opacity: 0.95;
            box-shadow: 4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light);
            transform: translateY(-1px);
        }
        
        .neumo-btn:active {
            box-shadow: var(--neumo-pressed);
            transform: translateY(0);
        }

        .neumo-btn-primary { 
            background: linear-gradient(145deg, var(--accent-yellow), var(--accent-orange)); 
            color: var(--text-dark); 
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.2), -4px -4px 10px rgba(255, 255, 255, 0.5); 
        }
        
        .neumo-btn-secondary { color: var(--text-dark); }

        .status-pill {
            background: linear-gradient(145deg, var(--accent-yellow), var(--accent-orange));
            color: var(--text-dark);
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .part-card {
            background-color: var(--bg-primary);
            border-radius: 2rem;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); 
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            color: var(--text-dark);
            border: none;
        }

        @media (min-width: 768px) {
            .part-card { grid-template-columns: 1fr 2.5fr; }
            .card-header-container {
                border-right: 1px solid var(--shadow-dark);
                padding-right: 2rem;
            }
        }
        
        .card-zoren-no {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent-orange);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            line-height: 1;
        }
        
        .oem-tag {
            background: #D1D5DB;
            color: var(--text-dark);
            padding: 0.3rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 700;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: inset 1px 1px 3px var(--shadow-dark), inset -1px -1px 3px var(--shadow-light);
        }

        input, select, textarea {
            border: none; 
            border-radius: 1.5rem;
            padding: 0.9rem 1.75rem; 
            background-color: var(--bg-primary); 
            color: var(--text-dark);
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }
        
        #modalAddEdit input, #modalAddEdit select, #modalAddEdit textarea, #modalAuth input {
            padding: 1rem 2rem; font-size: 1.125rem; font-weight: 600;
        }

        input:focus, select:focus, textarea:focus {
            background-color: var(--bg-primary);
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light), 0 0 0 2px var(--accent-yellow);
            outline: none;
        }
        
        .neumo-control-input {
            font-size: 1.125rem; padding: 1rem 2rem; border-radius: 2rem; font-weight: 600;
        }

        .modal-neumo { 
            background-color: var(--bg-primary); 
            border: 1px solid var(--shadow-light);
            border-radius: 2rem;
            box-shadow: var(--neumo-elevated);
        }
        
        .system-error {
            background-color: #FEE2E2; color: #DC2626;
            border-radius: 0.5rem; padding: 0.5rem 1rem;
            font-size: 0.875rem; font-weight: 500;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .text-light-override { color: var(--text-dark) !important; }

        .highlight {
            background-color: #FACC15; color: black; font-weight: 700; padding: 1px 3px; border-radius: 4px;
        }
        
        #auth-buttons .neumo-btn-secondary { background: var(--bg-primary); box-shadow: var(--neumo-elevated); }
        #auth-buttons .neumo-btn-primary { background: linear-gradient(145deg, var(--accent-yellow), var(--accent-orange)); }

        .price-tag-group {
            background: #e0e0e0;
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: var(--neumo-elevated);
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            border: 1px solid var(--shadow-light);
        }
        .price-label {
            font-size: 0.75rem; text-transform: uppercase; color: #6B7280; font-weight: 700;
        }
        .price-value {
            font-size: 1.1rem; font-weight: 800;
        }
        
        /* New Sell Button Style */
        .btn-sell-one {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: #DC2626;
            background: #E0E0E0;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            transition: all 0.1s;
        }
        .btn-sell-one:active {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
            color: #991B1B;
        }
        .btn-sell-one:hover {
            color: red;
        }

    </style>
</head>
<body class="min-h-screen text-gray-800 p-4 md:p-6">

<div class="max-w-7xl mx-auto">
    <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-center p-6 rounded-2xl">
        <div class="mb-4 md:mb-0">
            <h1 class="text-5xl font-extrabold text-gray-800 leading-tight">FASTWAY AUTO SPAREPARTS</h1>
            <p class="text-xl font-bold text-gray-600 mt-1">INVENTORY CATALOG</p>
        </div>
        <div class="flex flex-col items-end">
            <p id="authStatus" class="status-pill">AUTHENTICATING...</p>
            <p id="connectionLog" class="text-xs mt-1 text-gray-500">Starting initialization...</p>
            
            <div id="auth-buttons" class="flex flex-wrap gap-2 mt-3">
                <div id="loggedOutButtons" class="flex gap-2 hidden">
                    <button id="btnOpenSignIn" class="neumo-btn neumo-btn-secondary px-5 py-2 text-sm">Sign In</button>
                    <button id="btnOpenSignUp" class="neumo-btn neumo-btn-primary px-5 py-2 text-sm">Sign Up</button>
                </div>
                <div id="loggedInButtons" class="flex gap-2 hidden">
                    <button id="btnManageCategories" class="neumo-btn neumo-btn-secondary px-5 py-2 text-sm">Manage Categories</button>
                    <button id="btnLogout" class="neumo-btn neumo-btn-secondary px-5 py-2 text-sm">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <div id="rulesInstruction" class="hidden neumo-panel p-6 border-red-500 border-2">
        <p class="font-extrabold text-xl mb-2 text-red-600">ðŸ”´ CRITICAL ERROR: PERMISSION DENIED ðŸ”´</p>
        <p class="text-gray-700">Your application is authenticated, but the Firestore Security Rules are preventing it from reading data.</p>
        <pre id="rulesCode" class="bg-gray-200 text-yellow-700 p-4 rounded-lg mt-3 overflow-x-auto text-sm"></pre>
    </div>

    <section id="appContent" class="hidden">
        <section class="mb-10 p-4 md:p-6 neumo-panel flex flex-col md:flex-row flex-wrap gap-4 items-center" 
                 style="box-shadow: var(--neumo-pressed); padding: 1.5rem; border-radius: 2rem;">
            
            <div class="flex flex-wrap gap-4 w-full md:w-auto md:min-w-[200px]">
                <button id="btnAdd" class="neumo-btn neumo-btn-primary text-lg flex-grow">+ NEW PART</button>
                <button id="btnBulk" class="neumo-btn neumo-btn-secondary text-lg flex-grow">BULK JSON</button>
            </div>

            <div class="flex-grow flex flex-col md:flex-row items-center gap-4 w-full md:w-auto p-3 rounded-2xl bg-gray-300 bg-opacity-30">
                <select id="categoryFilter" class="neumo-control-input flex-grow w-full md:w-60"></select>
                <input id="searchInput" type="search" placeholder="SEARCH (ZOREN, OEM, MAKER, APP)" class="neumo-control-input flex-grow w-full md:flex-grow" />
                <select id="perPage" class="w-full md:w-32 neumo-control-input">
                    <option value="10">10 / Page</option>
                    <option value="25">25 / Page</option>
                    <option value="50">50 / Page</option>
                    <option value="100">100 / Page</option>
                </select>
            </div>
            
            <div class="flex flex-wrap gap-3 w-full md:w-auto md:justify-end">
                <button id="btnDownloadJson" class="neumo-btn neumo-btn-secondary bg-gray-400 text-light-override px-4 py-3 flex-grow md:flex-none">Export JSON</button>
                <button id="btnExportCsv" class="neumo-btn neumo-btn-secondary bg-green-500 text-light-override px-4 py-3 flex-grow md:flex-none">Export CSV</button>
            </div>
        </section>

        <section>
            <div id="partsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-8"></div>

            <div class="mt-10 neumo-panel p-4 flex flex-wrap gap-4 items-center justify-between text-gray-800">
                <div class="text-base font-semibold" id="summaryText">0 RECORDS LOADED</div>
                <div class="flex items-center gap-4">
                    <button id="prevPage" class="neumo-btn neumo-btn-secondary px-5 py-2">PREVIOUS</button>
                    <span id="pageInfo" class="px-3 text-lg font-extrabold"></span>
                    <button id="nextPage" class="neumo-btn neumo-btn-secondary px-5 py-2">NEXT</button>
                </div>
            </div>
        </section>
    </section>
</div>

<div id="modalConfirm" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"></div>
    <div class="modal-neumo z-50 w-full max-w-sm p-6 text-gray-800 border-yellow-700 border-t-2">
        <h3 id="confirmTitle" class="text-2xl font-bold mb-4">CONFIRM ACTION</h3>
        <p id="confirmMessage" class="text-gray-600 mb-6"></p>
        <div class="flex justify-end gap-3">
            <button id="btnConfirmCancel" class="neumo-btn neumo-btn-secondary px-5 py-2">CANCEL</button>
            <button id="btnConfirmAction" class="neumo-btn neumo-btn-primary px-5 py-2 bg-red-600 text-light-override">CONFIRM</button>
        </div>
    </div>
</div>

<div id="modalAddEdit" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"></div>
    <div class="modal-neumo z-50 w-full max-w-3xl p-8 text-gray-800 border-yellow-700 border-t-4 max-h-[90vh] overflow-y-auto">
        <h3 id="modalTitle" class="text-3xl font-extrabold mb-6">ADD/EDIT PART</h3>
        <p id="deduplicationWarning" class="text-sm font-semibold text-orange-600 mt-2 hidden system-error">
            Note: ZOREN No. must be unique if provided.
        </p>
        <div class="space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600">Category</label>
                    <select id="inpCategory" class="w-full"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">ZOREN No.</label>
                    <input id="inpZoren" class="w-full" />
                    <p id="zorenError" class="mt-2 hidden system-error"></p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-600">Car Maker</label>
                    <input id="inpCarMaker" class="w-full" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">Applications</label>
                    <input id="inpApplications" class="w-full" />
                </div>
            </div>

            <div class="p-4 rounded-xl bg-gray-300 bg-opacity-30 border border-gray-300">
                <h4 class="font-bold text-gray-700 mb-3 border-b border-gray-400 pb-1">INVENTORY & PRICING</h4>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Quantity (Pcs)</label>
                        <input type="number" id="inpQuantity" class="w-full" placeholder="0" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Cost Price</label>
                        <input type="number" step="0.01" id="inpCostPrice" class="w-full" placeholder="0.00" />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-green-700">Selling Price</label>
                        <input type="number" step="0.01" id="inpSellingPrice" class="w-full text-green-900" placeholder="0.00" />
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-600">OEM No. (comma separated)</label>
                <input id="inpOem" class="w-full" placeholder="31110-09000, E8678M" />
            </div>
        </div>

        <div class="mt-10 flex justify-end gap-3">
            <button id="btnCancelModal" class="neumo-btn neumo-btn-secondary px-6 py-2.5">CANCEL</button>
            <button id="btnSaveModal" class="neumo-btn neumo-btn-primary px-6 py-2.5">SAVE PART</button>
            </div>
        </div>
</div>

<div id="modalBulk" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"></div>
    <div class="modal-neumo z-50 w-full max-w-3xl p-8 text-gray-800 border-orange-600 border-t-4">
        <h3 class="text-3xl font-extrabold mb-6">BULK JSON UPLOAD</h3>
        <p class="text-sm text-gray-600 mb-4">Paste JSON array or upload a .json file. Supports: zoren, oem, car_maker, applications, quantity, cost_price, selling_price.</p>

        <div class="space-y-5">
            <div>
                <label class="block text-sm font-medium mb-1 text-gray-600">Paste JSON array</label>
                <textarea id="bulkTextarea" rows="8" class="w-full font-mono shadow-inner border-gray-400 bg-gray-200 bg-opacity-50" placeholder='[{"zoren":"ZRM...","quantity":10,"cost_price":50,"selling_price":80}]'></textarea>
            </div>
            <div id="bulkCategorySelector" class="flex flex-col gap-2 p-5 neumo-panel border-yellow-700 border-t-2">
                <label class="block text-base font-bold">Category Assignment for uncategorized imports:</label>
                <select id="bulkCategoryInput" class=""></select>
            </div>
        </div>

        <div class="mt-8 flex flex-wrap items-center gap-4">
            <input id="bulkFileInput" type="file" accept=".json,application/json" class="text-sm font-semibold text-gray-800" />
            <button id="btnLoadBulk" class="neumo-btn neumo-btn-secondary bg-gray-400 text-light-override px-5 py-2.5">Load & Merge</button>
            <button id="btnReplaceBulk" class="neumo-btn neumo-btn-primary px-5 py-2.5 bg-red-600 text-light-override">REPLACE ALL INVENTORY</button>
            <button id="btnCloseBulk" class="ml-auto neumo-btn neumo-btn-secondary px-5 py-2.5">CLOSE</button>
        </div>
        </div>
</div>

<div id="modalCategoryManager" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"></div>
    <div class="modal-neumo z-50 w-full max-w-md p-8 text-gray-800 border-gray-600 border-t-4">
        <h3 class="text-3xl font-extrabold mb-6">CATEGORY MANAGER</h3>
        <div class="space-y-5">
            <div class="flex gap-3">
                <input id="inpNewCategory" class="w-full" placeholder="e.g., Brake System" />
                <button id="btnAddCategory" class="neumo-btn neumo-btn-primary bg-green-600 text-light-override px-5 py-2">ADD</button>
            </div>
            <div id="categoryListContainer" class="max-h-64 overflow-y-auto border border-gray-400 rounded-xl p-4 space-y-3 neumo-panel"></div>
        </div>
        <div class="mt-8 flex justify-end">
            <button id="btnCloseCategoryManager" class="neumo-btn neumo-btn-primary px-6 py-2.5">DONE</button>
        </div>
    </div>
</div>

<div id="modalAuth" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"></div>
    <div class="modal-neumo z-50 w-full max-w-md p-8 text-gray-800 border-yellow-700 border-t-4">
        <h3 id="authModalTitle" class="text-3xl font-extrabold mb-6">Sign In</h3>
        <p id="authError" class="mt-2 hidden system-error"></p>
        <div class="space-y-5 mt-5">
            <div>
                <label class="block text-sm font-medium text-gray-600">Email</label>
                <input id="authEmail" type="email" class="w-full" placeholder="you@company.com" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600">Password</label>
                <input id="authPassword" type="password" class="w-full" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
            </div>
        </div>

        <div class="mt-8 flex justify-between items-center">
            <button id="btnToggleAuthMode" class="text-sm font-semibold text-gray-600 hover:text-gray-800">Need an account? Sign Up</button>
            <div class="flex gap-3">
                <button id="btnCloseAuthModal" class="neumo-btn neumo-btn-secondary px-6 py-2.5">CANCEL</button>
                <button id="btnAuthAction" class="neumo-btn neumo-btn-primary px-6 py-2.5">SIGN IN</button>
            </div>
        </div>
    </div>
</div>


<script type="module">
    // --- FIREBASE IMPORTS (Modern Modular SDK v11.6.1) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, getDoc, getDocs, deleteDoc, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL VARIABLES & INITIALIZATION ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    const userFirebaseConfig = {
        apiKey: "AIzaSyDMG67OjTem-qRC8S8NN58weeeHnZIGLW0",
        authDomain: "fastway-autospare-parts-shibi.firebaseapp.com",
        projectId: "fastway-autospare-parts-shibi",
        storageBucket: "fastway-autospare-parts-shibi.firebasestorage.app",
        messagingSenderId: "129701229596",
        appId: "1:129701229596:web:ff12c4d0ed2c87ee2d9bd9",
        measurementId: "G-JV6NF5FREJ"
    };

    const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const firebaseConfig = Object.keys(envConfig).length > 0 ? envConfig : userFirebaseConfig;

    let app, auth, db;
    
    function updateConnectionStatus(message, isError = false) {
        const logEl = getEl('connectionLog');
        if (logEl) {
            logEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.style.color = isError ? '#DC2626' : '#6B7280';
        }
    }

    function getEl(id) { return document.getElementById(id); }
    
    function displaySecurityRulesError(errorMessage) {
        const rulesInstruction = getEl('rulesInstruction');
        const rulesCode = getEl('rulesCode');
        rulesInstruction.classList.remove('hidden');
        getEl('appContent').classList.add('hidden');
        getEl('partsContainer').innerHTML = `<p class="text-center text-red-600 p-8 text-xl font-bold">Error: ${errorMessage}. See instructions above.</p>`;
        rulesCode.textContent = `
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() { return request.auth != null; }
    match /artifacts/{appId}/users/{userId}/{documents=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}`;
    }

    async function initApp() {
        updateConnectionStatus("Attempting Firebase initialization...");
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            updateConnectionStatus("Services initialized. Starting authentication check...");
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const display = user.email ? user.email : `UID: ${user.uid.substring(0, 8)}...`;
                    getEl('authStatus').textContent = `${display} (Authenticated)`;
                    getEl('appContent').classList.remove('hidden');
                    getEl('loggedInButtons').classList.remove('hidden');
                    getEl('loggedOutButtons').classList.add('hidden');
                    updateConnectionStatus("Authentication successful. Loading inventory...");
                    await loadCategories();
                    loadAndRenderParts();
                } else {
                    currentUser = null;
                    getEl('authStatus').textContent = `LOGGED OUT`;
                    getEl('appContent').classList.add('hidden');
                    getEl('loggedInButtons').classList.add('hidden');
                    getEl('loggedOutButtons').classList.remove('hidden');
                    updateConnectionStatus("Please sign in or sign up to access inventory.", true);
                    partsContainer.innerHTML = '<div><p class="text-xl text-center p-8 text-gray-500 font-bold">Please SIGN IN to view inventory.</p></div>';
                    if (partsSnapshotUnsubscribe) { partsSnapshotUnsubscribe(); }
                    if (!getEl('modalAuth').classList.contains('hidden')) return;
                    openAuthModal('signIn');
                }
            });
        } catch (error) {
            updateConnectionStatus("FATAL: Initialization failed. See console.", true);
            console.error("Firebase Initialization/Startup Error:", error);
        }
    }

    // --- APP STATE ---
    let parts = [];
    let editPartId = null; 
    let page = 1;
    let perPage = 10;
    let categories = [];
    let currentUser = null; 
    let partsSnapshotUnsubscribe = null;
    const partsContainer = document.getElementById('partsContainer');
    
    let confirmResolver;
    
    function showConfirm(title, message, isAlert = false) {
        return new Promise(resolve => {
            confirmResolver = resolve;
            getEl('confirmTitle').textContent = title;
            getEl('confirmMessage').textContent = message;
            const confirmBtn = getEl('btnConfirmAction');
            if (isAlert) {
                confirmBtn.textContent = 'OK';
                confirmBtn.classList.remove('bg-red-600');
                confirmBtn.classList.add('neumo-btn-primary');
            } else {
                confirmBtn.textContent = 'CONFIRM';
                confirmBtn.classList.add('bg-red-600');
            }
            getEl('btnConfirmCancel').classList.toggle('hidden', isAlert);
            getEl('modalConfirm').classList.remove('hidden');
        });
    }

    getEl('btnConfirmCancel')?.addEventListener('click', () => {
        getEl('modalConfirm').classList.add('hidden');
        confirmResolver(false);
    });
    getEl('btnConfirmAction')?.addEventListener('click', () => {
        getEl('modalConfirm').classList.add('hidden');
        confirmResolver(true);
    });

    function getUserCollectionPath(collectionName) {
        if (!currentUser || !currentUser.uid) throw new Error("User not authenticated.");
        return `artifacts/${appId}/users/${currentUser.uid}/${collectionName}`;
    }
    function getPartsCollectionRef() { return collection(db, getUserCollectionPath('parts')); }
    function getCategoryDocRef() { return doc(db, getUserCollectionPath('categories'), 'list'); }

    async function loadCategories() {
        if (!currentUser) return;
        try {
            const categoryDoc = await getDoc(getCategoryDocRef());
            if (categoryDoc.exists() && categoryDoc.data().list) {
                categories = categoryDoc.data().list.filter(c => c && c.trim()).map(c => c.trim());
                if (!categories.includes('Uncategorized')) categories.unshift('Uncategorized');
            } else {
                categories = ['Uncategorized', 'Fuel Injection', 'Brake System', 'Filters', 'Ignition'];
                await saveCategories();
            }
            renderCategorySelects();
        } catch (error) {
             if (error.code === 'permission-denied') displaySecurityRulesError('Data load failed due to security rules');
             else console.error("Error loading categories:", error);
        }
    }

    async function saveCategories() {
        if (!currentUser) return;
        try {
            let uniqueCategories = [...new Set(categories.map(c => c.trim()).filter(Boolean))];
            uniqueCategories = uniqueCategories.filter(c => c !== 'Uncategorized');
            uniqueCategories.unshift('Uncategorized');
            await setDoc(getCategoryDocRef(), { list: uniqueCategories });
            categories = uniqueCategories; 
            renderCategorySelects(); 
        } catch (error) { console.error("Error saving categories:", error); }
    }

    async function deleteCategory(categoryToDelete) {
        if (categoryToDelete === 'Uncategorized') return showConfirm('Error', 'Cannot delete "Uncategorized".', true);
        const confirmed = await showConfirm('Confirm Deletion', `Delete category: ${categoryToDelete}? Parts will move to "Uncategorized".`);
        if (!confirmed) return;
        
        const partsToUpdate = parts.filter(p => p.category === categoryToDelete);
        const updateBatch = writeBatch(db);
        partsToUpdate.forEach(part => {
            const partRef = doc(getPartsCollectionRef(), part.id);
            updateBatch.update(partRef, { category: 'Uncategorized' });
        });
        
        try {
            await updateBatch.commit();
            categories = categories.filter(c => c !== categoryToDelete);
            await saveCategories();
            renderCategoryManagerList();
            showConfirm('Category Deleted', `Category deleted. ${partsToUpdate.length} parts reassigned.`, true);
        } catch (error) { console.error("Category deletion error:", error); }
    }

    function renderCategoryManagerList() {
        const container = document.getElementById('categoryListContainer');
        container.innerHTML = categories.map((cat, index) => `
            <div class="flex justify-between items-center p-3 bg-gray-200 rounded-lg shadow-inner">
                <span class="text-base font-semibold text-gray-800">${escapeHtml(cat)}</span>
                <button onclick="window.deleteCategoryHandler('${escapeHtml(cat)}')" class="text-red-600 hover:text-red-500 text-sm font-bold disabled:opacity-50" ${cat === 'Uncategorized' ? 'disabled' : ''}>REMOVE</button>
            </div>
        `).join('') || '<p class="text-center text-gray-500 text-sm italic">No categories defined.</p>';
    }
    window.deleteCategoryHandler = deleteCategory;

    function renderCategorySelects(selectedCategory = '') {
        const selects = [document.getElementById('inpCategory'), document.getElementById('bulkCategoryInput'), document.getElementById('categoryFilter')];
        const standardOptions = categories.map(cat => `<option value="${escapeHtml(cat)}" ${cat === selectedCategory ? 'selected' : ''}>${escapeHtml(cat)}</option>`).join('');
        const filterOptions = [`<option value="">ALL CATEGORIES</option>`, ...categories.map(cat => `<option value="${escapeHtml(cat)}" ${cat === selectedCategory ? 'selected' : ''}>${escapeHtml(cat)}</option>`)].join('');

        selects.forEach(select => {
            if (select) {
                if (select.id === 'categoryFilter') {
                    select.innerHTML = filterOptions;
                    if (!select._initialized) {
                         select.addEventListener('change', () => { page = 1; renderCards(); });
                         select._initialized = true;
                    }
                } else select.innerHTML = standardOptions;
            }
        });
    }

    let authMode = 'signIn';
    function openAuthModal(mode) {
        authMode = mode;
        getEl('authModalTitle').textContent = mode === 'signIn' ? 'Sign In' : 'Create New Account';
        getEl('btnAuthAction').textContent = mode === 'signIn' ? 'SIGN IN' : 'SIGN UP';
        getEl('btnToggleAuthMode').textContent = mode === 'signIn' ? 'Need an account? Sign Up' : 'Have an account? Sign In';
        getEl('authError').classList.add('hidden');
        getEl('authEmail').value = '';
        getEl('authPassword').value = '';
        getEl('modalAuth').classList.remove('hidden');
    }

    async function handleAuthAction() {
        const email = getEl('authEmail').value.trim();
        const password = getEl('authPassword').value.trim();
        const errorEl = getEl('authError');
        errorEl.classList.add('hidden');

        if (!email || !password) { errorEl.textContent = 'Email and password required.'; errorEl.classList.remove('hidden'); return; }
        
        getEl('btnAuthAction').disabled = true;
        try {
            if (authMode === 'signUp') await createUserWithEmailAndPassword(auth, email, password);
            else await signInWithEmailAndPassword(auth, email, password);
            getEl('modalAuth').classList.add('hidden');
        } catch (error) {
            let msg = 'Error.';
            if (error.code === 'auth/email-already-in-use') msg = 'Email already registered.';
            else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg = 'Invalid credentials.';
            else if (error.code === 'auth/weak-password') msg = 'Password too weak.';
            errorEl.textContent = msg;
            errorEl.classList.remove('hidden');
        } finally { getEl('btnAuthAction').disabled = false; }
    }

    getEl('btnOpenSignIn')?.addEventListener('click', () => openAuthModal('signIn'));
    getEl('btnOpenSignUp')?.addEventListener('click', () => openAuthModal('signUp'));
    getEl('btnCloseAuthModal')?.addEventListener('click', () => getEl('modalAuth').classList.add('hidden'));
    getEl('btnAuthAction')?.addEventListener('click', handleAuthAction);
    getEl('btnToggleAuthMode')?.addEventListener('click', () => openAuthModal(authMode === 'signIn' ? 'signUp' : 'signIn'));
    
    getEl('btnLogout')?.addEventListener('click', async () => {
        if (await showConfirm('Confirm Logout', 'Are you sure?', false)) await signOut(auth);
    });

    function normalizeRecord(item) {
        const zoren = (item.zoren ?? '').toString().trim();
        let oem = item.oem ?? [];
        if (typeof oem === 'string') oem = oem.split(',').map(s=>s.trim()).filter(Boolean);
        else if (!Array.isArray(oem)) oem = [];
        const car_maker = (item.car_maker ?? '').toString().trim();
        const applications = (item.applications ?? '').toString().trim();
        const category = (item.category ?? 'Uncategorized').toString().trim(); 
        const quantity = item.quantity ? Number(item.quantity) : 0;
        const costPrice = item.costPrice ? Number(item.costPrice) : 0;
        const sellingPrice = item.sellingPrice ? Number(item.sellingPrice) : 0;
        return { zoren, oem, car_maker, applications, category, quantity, costPrice, sellingPrice };
    }
    
    function escapeHtml(s){ return s? String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') : ''; }
    function highlightSearchTerm(text, query) {
        if (!query) return escapeHtml(text);
        const escapedText = escapeHtml(text);
        const regex = new RegExp(query, 'gi');
        return escapedText.replace(regex, (match) => `<span class="highlight">${match}</span>`);
    }

    function checkIfZorenExists(zoren, excludeId = null) {
        const normalizedZoren = zoren.trim().toLowerCase();
        if (normalizedZoren === '') return false;
        return parts.some(p => p.zoren.trim().toLowerCase() === normalizedZoren && p.id !== excludeId);
    }

    function loadAndRenderParts() {
        if (!currentUser || !db) return;
        partsContainer.innerHTML = '<div><p class="text-xl text-center p-8 text-gray-500 font-bold">LOADING INVENTORY...</p></div>';
        if (partsSnapshotUnsubscribe) partsSnapshotUnsubscribe();
        
        try {
            partsSnapshotUnsubscribe = onSnapshot(getPartsCollectionRef(), (snapshot) => {
                parts = [];
                snapshot.forEach(doc => {
                    try {
                        const part = normalizeRecord(doc.data());
                        part.id = doc.id; 
                        parts.push(part);
                    } catch (e) { console.error("Error normalizing part:", e); }
                });
                renderCards();
                if (parts.length === 0) partsContainer.innerHTML = '<div><p class="text-xl text-center p-8 text-gray-500 font-bold">NO PARTS FOUND.</p></div>';
            }, (error) => {
                if (error.code === 'permission-denied') displaySecurityRulesError('Data stream failed due to security rules');
                else partsContainer.innerHTML = `<div><p class="text-xl text-center p-8 text-red-600 font-bold">ERROR: ${error.message}</p></div>`;
            });
        } catch (e) { console.error("Snapshot error:", e); }
    }

    function renderCards() { 
        if (!currentUser) return;
        const q = document.getElementById('searchInput')?.value.trim();
        const qLower = q ? q.toLowerCase() : '';
        const selectedCategoryFilter = document.getElementById('categoryFilter')?.value || '';
        perPage = parseInt(document.getElementById('perPage')?.value, 10) || 10; 

        let filtered = parts.filter(item => {
            if (selectedCategoryFilter && item.category !== selectedCategoryFilter) return false;
            if (qLower) {
                const searchString = `${item.zoren} ${item.oem.join(' ')} ${item.car_maker} ${item.applications} ${item.category}`.toLowerCase();
                return searchString.includes(qLower);
            }
            return true;
        });

        filtered.sort((a,b)=>a.zoren.localeCompare(b.zoren, undefined, {numeric:true}));
        const total = filtered.length;
        const pages = Math.max(1, Math.ceil(total/perPage));
        if (page > pages) page = pages;
        page = Math.max(1, page);
        
        const start = (page-1)*perPage;
        const pageItems = filtered.slice(start, start+perPage);

        partsContainer.innerHTML = '';
        pageItems.forEach((item,i)=>{
            const oemTags = item.oem.map(oem => `<span class="oem-tag">${highlightSearchTerm(oem, q)}</span>`).join('');
            const card = document.createElement('div');
            card.className = 'part-card';
            card.innerHTML = `
                <div class="flex flex-col justify-between card-header-container">
                    <div>
                        <div class="text-sm font-extrabold text-gray-500 mb-2 uppercase">${highlightSearchTerm(item.category || '(NO CATEGORY)', q)}</div>
                        <h3 class="card-zoren-no font-mono">${highlightSearchTerm(item.zoren || '(NO ZOREN)', q)}</h3>
                    </div>
                    <div class="card-actions flex gap-3 mt-4">
                        <button class="editBtn text-gray-600 hover:text-gray-800" title="Edit" data-id="${escapeHtml(item.id)}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <button class="delBtn text-red-600 hover:text-red-500" title="Delete" data-id="${escapeHtml(item.id)}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>
                <div class="card-details-grid text-lg font-medium">
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <div class="text-sm font-bold text-gray-500 uppercase">Car Maker:</div>
                            <div class="text-gray-800">${highlightSearchTerm(item.car_maker || 'N/A', q)}</div>
                        </div>
                         <div>
                            <div class="text-sm font-bold text-gray-500 uppercase">Applications:</div>
                            <div class="text-gray-800">${highlightSearchTerm(item.applications || 'N/A', q)}</div>
                        </div>
                    </div>
                    
                    <div class="price-tag-group">
                        <div class="text-center">
                             <div class="price-label">Qty</div>
                             <div class="flex items-center justify-center gap-2">
                                 <span class="price-value text-blue-800">${item.quantity || 0}</span>
                                 <button class="btnSellOne btn-sell-one" title="Sell One (Decrease Stock)" data-id="${item.id}">-1</button>
                             </div>
                        </div>
                        <div class="text-center border-l border-gray-400 pl-4">
                             <div class="price-label">Cost</div>
                             <div class="price-value text-gray-600">${item.costPrice?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="text-center border-l border-gray-400 pl-4">
                             <div class="price-label">Selling</div>
                             <div class="price-value text-green-700">${item.sellingPrice?.toFixed(2) || '0.00'}</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="text-sm font-bold text-gray-500 uppercase">OEM No. / Interchange:</div>
                        <div class="flex flex-wrap pt-1 min-h-[30px]">${oemTags || 'N/A'}</div>
                    </div>
                </div>
            `;
            partsContainer.appendChild(card);
        });

        document.getElementById('summaryText').textContent = `${total} RECORDS (${pageItems.length} VISIBLE)`;
        document.getElementById('pageInfo').textContent = `PAGE ${page} / ${pages}`;
        
        getEl('prevPage').disabled = page === 1;
        getEl('nextPage').disabled = page === pages;

        Array.from(document.getElementsByClassName('editBtn')).forEach(b=>b.addEventListener('click', onEdit));
        Array.from(document.getElementsByClassName('delBtn')).forEach(b=>b.addEventListener('click', onDelete));
        // NEW EVENT LISTENER FOR QUICK SALE
        Array.from(document.getElementsByClassName('btnSellOne')).forEach(b=>b.addEventListener('click', onQuickSell));
    }
    
    // --- NEW: QUICK SELL FUNCTIONALITY ---
    async function onQuickSell(e) {
        const id = e.currentTarget.getAttribute('data-id');
        const part = parts.find(p => p.id === id);
        if (!part) return;

        if (part.quantity <= 0) {
            showConfirm('Out of Stock', 'Quantity is already 0.', true);
            return;
        }

        const newQty = part.quantity - 1;
        
        try {
            const partRef = doc(db, getUserCollectionPath('parts'), id);
            await updateDoc(partRef, { quantity: newQty });
            // UI will update automatically via onSnapshot
        } catch (err) {
            console.error("Quick Sell Error:", err);
            showConfirm('Error', 'Failed to update stock.', true);
        }
    }

    getEl('prevPage')?.addEventListener('click', ()=>{ page=Math.max(1,page-1); renderCards(); });
    getEl('nextPage')?.addEventListener('click', ()=>{ page++; renderCards(); });
    getEl('searchInput')?.addEventListener('input', ()=>{ page=1; renderCards(); });
    getEl('perPage')?.addEventListener('change', ()=>{ page=1; renderCards(); });
    
    const modalAddEdit = getEl('modalAddEdit');
    getEl('btnAdd')?.addEventListener('click', ()=>{ openAddModal(); });
    getEl('btnCancelModal')?.addEventListener('click', ()=>modalAddEdit?.classList.add('hidden'));

    getEl('btnSaveModal')?.addEventListener('click', async ()=>{
        if (!currentUser) { showConfirm('Auth Error', 'Authentication is required.', true); return; }

        const zoren = getEl('inpZoren')?.value.trim();
        const category = getEl('inpCategory')?.value.trim();
        const car_maker=getEl('inpCarMaker')?.value.trim();
        const applications=getEl('inpApplications')?.value.trim();
        const quantity = Number(getEl('inpQuantity')?.value) || 0;
        const costPrice = Number(getEl('inpCostPrice')?.value) || 0;
        const sellingPrice = Number(getEl('inpSellingPrice')?.value) || 0;

        getEl('zorenError')?.classList.add('hidden');

        const isDuplicate = checkIfZorenExists(zoren, editPartId);
        if (zoren !== '' && isDuplicate) {
            getEl('zorenError').textContent = `DEDUPLICATION ERROR: ZOREN No. "${zoren}" already exists.`;
            getEl('zorenError').classList.remove('hidden');
            return;
        }

        let oemRaw=getEl('inpOem')?.value.trim();
        let oemArr = oemRaw ? oemRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
        
        const dataToSave = { zoren, oem: oemArr, car_maker, applications, category, quantity, costPrice, sellingPrice };

        try {
            if (editPartId) await setDoc(doc(getPartsCollectionRef(), editPartId), dataToSave);
            else await addDoc(getPartsCollectionRef(), dataToSave);
            modalAddEdit.classList.add('hidden');
        } catch (error) { console.error("Error saving document: ", error); }
    });

    function openAddModal(item=null, partId=null){ 
        if (!currentUser) { showConfirm('Access Denied', 'Please sign in.', true); return; }
        editPartId = partId; 
        getEl('zorenError')?.classList.add('hidden');
        getEl('deduplicationWarning').classList.remove('hidden');
        getEl('modalTitle').textContent=item?'EDIT PART':'ADD PART';
        getEl('inpZoren').value=item?item.zoren:'';
        getEl('inpZoren').disabled = !!item; 
        getEl('inpOem').value=item?item.oem.join(', '):'';
        getEl('inpCarMaker').value=item?item.car_maker:'';
        getEl('inpApplications').value=item?item.applications:'';
        getEl('inpQuantity').value = item ? item.quantity : '';
        getEl('inpCostPrice').value = item ? item.costPrice : '';
        getEl('inpSellingPrice').value = item ? item.sellingPrice : '';
        renderCategorySelects(item ? item.category : categories[0]); 
        modalAddEdit.classList.remove('hidden');
    }

    function onEdit(e){ 
        const partId = e.currentTarget.getAttribute('data-id');
        const partToEdit = parts.find(p => p.id === partId); 
        if (partToEdit) openAddModal(partToEdit, partToEdit.id);
    }
    
    async function onDelete(e){ 
        if (!currentUser) return;
        const partId = e.currentTarget.getAttribute('data-id'); 
        const partToDelete = parts.find(p => p.id === partId); 
        if (!partToDelete) return;
        if (await showConfirm('Confirm Deletion', `Permanently delete ZOREN No. ${partToDelete.zoren}?`)) {
            await deleteDoc(doc(getPartsCollectionRef(), partToDelete.id));
        }
    } 

    const modalBulk=getEl('modalBulk');
    getEl('btnBulk')?.addEventListener('click',()=>{ 
        if (!currentUser) { showConfirm('Access Denied', 'Please sign in.', true); return; }
        modalBulk.classList.remove('hidden'); 
        getEl('bulkCategorySelector').classList.remove('hidden');
        renderCategorySelects();
    });
    getEl('btnCloseBulk')?.addEventListener('click',()=>modalBulk.classList.add('hidden'));
    
    getEl('bulkFileInput')?.addEventListener('change',ev=>{
        const f=ev.target.files[0]; 
        if(!f) return; 
        const reader=new FileReader();
        reader.onload=e=>getEl('bulkTextarea').value=e.target.result; 
        showConfirm('File Loaded', "JSON loaded. Click 'Load & Merge' or 'Replace All'.", true);
    });
    
    async function executeBatchUpload(records, replaceMode) {
        if (!currentUser) throw new Error('Authentication required.');
        const existingZorens = new Set(parts.map(p => p.zoren.trim().toLowerCase()).filter(z => z !== ''));
        let recordsToAdd = [];
        let duplicatesCount = 0;

        for (const record of records) {
            const zoren = record.zoren ? record.zoren.trim() : '';
            const normalizedZoren = zoren.toLowerCase();
            if (zoren !== '') {
                 if (replaceMode || !existingZorens.has(normalizedZoren)) {
                    recordsToAdd.push(record);
                    existingZorens.add(normalizedZoren); 
                } else duplicatesCount++;
            } else recordsToAdd.push(record); 
        }

        if (recordsToAdd.length === 0) throw new Error(`Import failed. ${duplicatesCount} duplicates ignored.`);
        const batch = writeBatch(db);
        if (replaceMode) {
            const existingSnapshot = await getDocs(getPartsCollectionRef());
            existingSnapshot.forEach(doc => { batch.delete(doc.ref); });
        }
        recordsToAdd.forEach(record => {
            const newDocRef = doc(getPartsCollectionRef());
            const { id, ...data } = record; 
            batch.set(newDocRef, data);
        });
        await batch.commit();
        getEl('bulkTextarea').value=''; 
        modalBulk.classList.add('hidden'); 
        return { added: recordsToAdd.length, duplicates: duplicatesCount };
    }
    
    async function handleBulkUpload(replaceMode) {
        const txt=getEl('bulkTextarea')?.value.trim(); 
        if(!txt) return showConfirm('Input Empty', 'Bulk textarea is empty.', true);
        if(replaceMode && !(await showConfirm('DANGER: REPLACE ALL', 'Delete ALL existing data and replace? This is PERMANENT.', false))) return;

        try { 
            const parsed=JSON.parse(txt); 
            if(!Array.isArray(parsed)) return showConfirm('Invalid Format', 'JSON must be array.', true);
            let recordsToImport = parsed.map(normalizeRecord);
            const selectedCategory = getEl('bulkCategoryInput').value.trim();
            const finalRecords = recordsToImport.map(r => ({ ...r, category: r.category === 'Uncategorized' ? selectedCategory : r.category }));
            const results = await executeBatchUpload(finalRecords, replaceMode);
            showConfirm('Upload Complete', replaceMode ? `Replaced all. Added ${results.added}.` : `Merged ${results.added}. Ignored ${results.duplicates}.`, true);
        } catch(err){ 
            showConfirm('Processing Error', `Error: ${err.message}`, true); 
        }
    }

    getEl('btnLoadBulk')?.addEventListener('click', () => handleBulkUpload(false));
    getEl('btnReplaceBulk')?.addEventListener('click', () => handleBulkUpload(true));

    const modalCategoryManager = getEl('modalCategoryManager');
    getEl('btnManageCategories')?.addEventListener('click', () => { renderCategoryManagerList(); modalCategoryManager?.classList.remove('hidden'); });
    getEl('btnCloseCategoryManager')?.addEventListener('click', () => { modalCategoryManager?.classList.add('hidden'); });
    getEl('btnAddCategory')?.addEventListener('click', async () => {
        const newCat = getEl('inpNewCategory')?.value.trim();
        if (!newCat) return showConfirm('Error', 'Category name empty.', true);
        if (categories.includes(newCat)) return showConfirm('Error', 'Category exists.', true);
        categories.push(newCat);
        getEl('inpNewCategory').value = '';
        await saveCategories(); 
        renderCategoryManagerList();
    });

    function createDownloadLink(data, filename, mimeType) {
        const blob = new Blob([data], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    getEl('btnDownloadJson')?.addEventListener('click', () => {
        const dataToExport = parts.map(p => ({
            zoren: p.zoren, car_maker: p.car_maker, applications: p.applications, oem: p.oem, category: p.category, quantity: p.quantity, costPrice: p.costPrice, sellingPrice: p.sellingPrice
        }));
        createDownloadLink(JSON.stringify(dataToExport, null, 2), `inventory_export_${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
    });

    getEl('btnExportCsv')?.addEventListener('click', () => {
        if (parts.length === 0) return showConfirm('Export Error', 'No data.', true);
        const headers = ["ZOREN No.", "Car Maker", "Applications", "OEM No.", "Category", "Quantity", "Cost Price", "Selling Price"];
        const rows = parts.map(p => [ p.zoren, p.car_maker, p.applications, p.oem.join('; '), p.category, p.quantity, p.costPrice, p.sellingPrice ]);
        const csvContent = [ headers.map(h => `"${h}"`).join(','), ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')) ].join('\n');
        createDownloadLink(csvContent, `inventory_export_${new Date().toISOString().slice(0, 10)}.csv`, 'text/csv');
    });

    document.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>
