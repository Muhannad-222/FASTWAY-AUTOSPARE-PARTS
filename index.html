<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>FastWay Inventory: Neumorphic Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Neumorphism Aesthetic */
        :root {
            /* Palette: Light, Soft Grays, Muted Accents */
            --bg-primary: #e0e5ec; /* Soft Light Gray for the overall background */
            --neumorphic-base: #e0e5ec; /* Base color for neumorphic elements */
            --neumorphic-light-shadow: #ffffff; /* Light shadow for "out" effect */
            --neumorphic-dark-shadow: #a3b1c6; /* Dark shadow for "out" effect */
            --neumorphic-pressed-light-shadow: #ffffff; /* Light shadow for "in" (pressed) effect */
            --neumorphic-pressed-dark-shadow: #b8c2d1; /* Dark shadow for "in" (pressed) effect */
            
            /* Muted accent colors */
            --accent-green: #9fd3c7; /* Muted Green for Primary actions */
            --accent-blue: #3f72af; /* Muted Blue for Secondary actions */
            --accent-text: #36454F; /* Charcoal for main text */
            --subtle-text: #6b7280; /* Gray for subtle text */
            --status-online: #4CAF50; /* Green for online status */
            --status-offline: #F44336; /* Red for offline status */
        }

        body { 
            background-color: var(--bg-primary); 
            font-family: 'Sora', sans-serif; /* Soft, modern font */
            color: var(--accent-text); /* Default text color */
        }

        /* --- Neumorphism Base Styles --- */
        .neumorphic-panel {
            background-color: var(--neumorphic-base);
            border-radius: 1.5rem; /* Soft, rounded corners */
            box-shadow: 
                6px 6px 12px var(--neumorphic-dark-shadow),
                -6px -6px 12px var(--neumorphic-light-shadow); /* Soft 'out' shadow */
            transition: all 0.2s ease-in-out;
        }

        /* For 'pressed in' elements like inputs */
        .neumorphic-inset {
            background-color: var(--neumorphic-base);
            border-radius: 1rem;
            box-shadow: 
                inset 3px 3px 6px var(--neumorphic-dark-shadow),
                inset -3px -3px 6px var(--neumorphic-light-shadow); /* Soft 'in' shadow */
            transition: all 0.2s ease-in-out;
        }
        
        /* High-Contrast, Pill-Shaped Buttons */
        .neo-btn {
            font-weight: 500; /* Softer font weight */
            border-radius: 9999px; /* Pill shape */
            padding: 0.75rem 1.5rem;
            border: none;
            letter-spacing: 0.01em;
            background-color: var(--neumorphic-base); /* Base background */
            box-shadow: 
                4px 4px 8px var(--neumorphic-dark-shadow),
                -4px -4px 8px var(--neumorphic-light-shadow); /* Soft 'out' shadow */
            transition: all 0.2s ease-in-out;
            color: var(--accent-text);
        }

        .neo-btn:hover {
            box-shadow: 
                2px 2px 4px var(--neumorphic-dark-shadow),
                -2px -2px 4px var(--neumorphic-light-shadow); /* Slightly less pronounced on hover */
            transform: translateY(-1px);
        }

        .neo-btn:active {
            box-shadow: 
                inset 2px 2px 5px var(--neumorphic-pressed-dark-shadow),
                inset -2px -2px 5px var(--neumorphic-pressed-light-shadow); /* Pressed 'in' effect */
            transform: translateY(1px);
            color: var(--accent-text); /* Keep text color consistent */
        }

        .neo-btn-primary { 
            color: var(--accent-text); /* Primary buttons might have a subtle accent color or just stand out by depth */
            background-color: var(--accent-green); /* Muted green for primary action */
            box-shadow: 
                4px 4px 8px rgba(0, 0, 0, 0.2), /* A bit stronger shadow for primary */
                -4px -4px 8px var(--neumorphic-light-shadow);
        }
        .neo-btn-primary:active {
            background-color: var(--accent-green);
            box-shadow: 
                inset 2px 2px 5px rgba(0, 0, 0, 0.3),
                inset -2px -2px 5px var(--neumorphic-pressed-light-shadow);
        }

        .neo-btn-secondary { 
            background-color: var(--neumorphic-base); 
            color: var(--subtle-text); 
        }

        /* Status Pill Style (more subtle neumorphic feel) */
        .status-pill {
            background-color: var(--neumorphic-base);
            color: var(--subtle-text);
            border-radius: 9999px;
            padding: 0.5rem 1.2rem;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 
                2px 2px 4px var(--neumorphic-dark-shadow),
                -2px -2px 4px var(--neumorphic-light-shadow);
            display: flex; /* Ensure inline-flex for proper content alignment */
            align-items: center;
        }
        /* Add a small circle for status indicator */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); /* Inset shadow for a subtle sphere effect */
        }
        #authStatus[data-status="authenticating"] .status-indicator { background-color: orange; }
        #authStatus[data-status="authenticated"] .status-indicator { background-color: var(--status-online); }
        #authStatus[data-status="auth-fail"] .status-indicator { background-color: var(--status-offline); }


        /* Inventory Card (Neumorphic) */
        .part-card {
            background-color: var(--neumorphic-base);
            border-radius: 1.5rem;
            box-shadow: 
                8px 8px 16px var(--neumorphic-dark-shadow),
                -8px -8px 16px var(--neumorphic-light-shadow); /* Deeper 'out' shadow for cards */
            padding: 2.5rem; /* More padding for spacious feel */
            display: flex; /* Use flexbox for single column on small screens, then grid */
            flex-direction: column;
            gap: 1.5rem;
            color: var(--accent-text);
        }

        @media (min-width: 768px) {
            .part-card {
                display: grid;
                grid-template-columns: 1fr 2fr; /* Clearer column separation */
                gap: 2rem; /* More space between columns */
            }
            .card-header-container {
                /* No border, rely on spacing and typography */
            }
        }
        
        .card-zoren-no {
            font-size: 2.75rem; /* Slightly larger, more dominant */
            font-weight: 700; /* Bolder */
            color: var(--accent-blue); /* Muted blue for emphasis */
            line-height: 1;
        }
        
        .oem-tag {
            background-color: var(--neumorphic-base);
            color: var(--subtle-text);
            padding: 0.3rem 0.8rem;
            border-radius: 0.75rem; /* Rounded but not pill */
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 
                2px 2px 4px var(--neumorphic-dark-shadow),
                -2px -2px 4px var(--neumorphic-light-shadow); /* Subtle neumorphic tag */
        }

        /* Styling for inputs and selects (Neumorphic Inset) */
        input, select, textarea {
            border: none; 
            border-radius: 1rem; /* Softer rounded corners */
            padding: 0.85rem 1.2rem; /* More internal padding */
            background-color: var(--neumorphic-base);
            color: var(--accent-text);
            font-weight: 400; /* Lighter font weight */
            box-shadow: 
                inset 3px 3px 6px var(--neumorphic-pressed-dark-shadow),
                inset -3px -3px 6px var(--neumorphic-pressed-light-shadow); /* Inset shadow */
            transition: all 0.2s;
        }

        input::placeholder, textarea::placeholder {
            color: var(--subtle-text);
            opacity: 0.7;
        }

        input:focus, select:focus, textarea:focus {
            box-shadow: 
                inset 2px 2px 5px var(--neumorphic-dark-shadow),
                inset -2px -2px 5px var(--neumorphic-light-shadow),
                0 0 0 2px var(--accent-green); /* Subtle focus ring */
            outline: none;
            background-color: var(--neumorphic-base); /* Ensure background stays consistent */
        }

        /* Modal: Full neumorphic panel */
        .modal-neumorphic { 
            background-color: var(--neumorphic-base); 
            border-radius: 2rem;
            box-shadow: 
                10px 10px 20px var(--neumorphic-dark-shadow),
                -10px -10px 20px var(--neumorphic-light-shadow); /* Pronounced shadow for modals */
        }
        
        /* Error Alert (Subtle Neumorphic) */
        .system-error {
            background-color: var(--neumorphic-base);
            color: var(--status-offline); /* Red for errors */
            border-radius: 0.75rem;
            padding: 0.6rem 1.2rem;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 
                2px 2px 4px var(--neumorphic-dark-shadow),
                -2px -2px 4px var(--neumorphic-light-shadow);
        }
        
        /* Remove old styles */
        .glass-panel, .ios-btn, .ios-btn-primary, .ios-btn-secondary, .status-pill, .part-card {
            /* Deactivate old styles to avoid conflict */
            background-color: initial !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
            background-image: none !important;
            color: initial !important; /* Reset specific color directives */
        }

        /* Header specific */
        header {
            background-color: var(--neumorphic-base);
            box-shadow: 
                6px 6px 12px var(--neumorphic-dark-shadow),
                -6px -6px 12px var(--neumorphic-light-shadow);
            border-radius: 2rem;
            padding: 2.5rem;
        }

        h1 {
            font-weight: 700; /* Bolder for titles */
            color: var(--accent-blue); /* Muted blue for main title */
        }
        header p {
            color: var(--subtle-text);
        }

        /* Modal specific changes */
        #modalConfirm .modal-neumorphic { border-top: 4px solid var(--accent-green); }
        #modalAddEdit .modal-neumorphic { border-top: 4px solid var(--accent-blue); }
        #modalBulk .modal-neumorphic { border-top: 4px solid var(--status-offline); } /* Using red for bulk operations as they can be destructive */
        #modalCategoryManager .modal-neumorphic { border-top: 4px solid var(--subtle-text); }


        /* Ensure content is visible against light background */
        .text-white, .text-gray-300, .text-gray-400, .text-gray-500, .text-gray-800 {
            color: var(--accent-text) !important;
        }
        /* Specific override for status pill, which might have a different default */
        #authStatus { color: var(--subtle-text); }


        #rulesInstruction {
            border: 2px solid var(--status-offline); /* Red border for errors */
            color: var(--accent-text);
            background-color: var(--neumorphic-base);
            box-shadow: 
                6px 6px 12px var(--neumorphic-dark-shadow),
                -6px -6px 12px var(--neumorphic-light-shadow);
        }
        #rulesInstruction p {
            color: var(--accent-text);
        }
        #rulesCode {
            background-color: #2c3e50; /* Darker background for code block */
            color: #ecf0f1; /* Light text for code */
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">

<div class="max-w-7xl mx-auto">
    <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-center p-6 rounded-2xl neumorphic-panel">
        <div class="mb-4 md:mb-0">
            <h1 class="text-5xl font-extrabold leading-tight">INVENTORY PRO</h1>
            <p class="text-xl font-bold mt-1">FASTWAY PARTS CATALOG</p>
        </div>
        <div class="flex flex-col items-end">
            <p id="authStatus" class="status-pill" data-status="authenticating">
                <span class="status-indicator"></span>AUTHENTICATING...
            </p>
            <p id="connectionLog" class="text-xs mt-1">Starting initialization...</p>
            <button id="btnManageCategories" class="neo-btn neo-btn-secondary mt-3 px-5 py-2 text-sm hidden">
                Manage Categories
            </button>
        </div>
    </header>

    <div id="rulesInstruction" class="hidden neumorphic-panel p-6">
        <p class="font-extrabold text-xl mb-2 text-red-500">ðŸ”´ CRITICAL ERROR: PERMISSION DENIED ðŸ”´</p>
        <p>Your application is authenticated, but the Firestore Security Rules are preventing it from reading data.</p>
        <p class="mt-2">To fix this, go to the Firebase Console > Firestore Database > Rules, and replace the existing rules with the code below.</p>
        <pre id="rulesCode" class="bg-gray-800 text-yellow-300 p-4 rounded-lg mt-3 overflow-x-auto text-sm"></pre>
    </div>

    <section id="appContent" class="hidden">
        <section class="mb-10 p-4 md:p-6 neumorphic-panel flex flex-wrap gap-4 items-center">
            <button id="btnAdd" class="neo-btn neo-btn-primary text-lg">+ NEW PART</button>
            <button id="btnBulk" class="neo-btn neo-btn-secondary text-lg">BULK JSON</button>

            <div class="flex-grow flex flex-wrap justify-end items-center gap-3">
                <select id="categoryFilter" class="neumorphic-inset w-full md:w-48"></select>

                <input id="searchInput" type="search" placeholder="SEARCH (ZOREN, OEM, MAKER, APP)" class="neumorphic-inset w-full md:max-w-xs" />
                <select id="perPage" class="neumorphic-inset w-24">
                    <option value="10">10 / Page</option>
                    <option value="25">25 / Page</option>
                    <option value="50">50 / Page</option>
                </select>
            </div>
            
            <button id="btnDownloadJson" class="neo-btn neo-btn-secondary px-4 py-3">Export JSON</button>
            <button id="btnExportCsv" class="neo-btn neo-btn-secondary px-4 py-3">Export CSV</button>
        </section>

        <section>
            <div id="partsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                </div>

            <div class="mt-10 neumorphic-panel p-4 flex flex-wrap gap-4 items-center justify-between">
                <div class="text-base font-semibold" id="summaryText">0 RECORDS LOADED</div>
                <div class="flex items-center gap-4">
                    <button id="prevPage" class="neo-btn neo-btn-secondary px-5 py-2">PREVIOUS</button>
                    <span id="pageInfo" class="px-3 text-lg font-extrabold"></span>
                    <button id="nextPage" class="neo-btn neo-btn-secondary px-5 py-2">NEXT</button>
                </div>
            </div>
        </section>
    </section>
</div>

<div id="modalConfirm" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30"></div> <div class="modal-neumorphic z-50 w-full max-w-sm p-6">
        <h3 id="confirmTitle" class="text-2xl font-bold mb-4">CONFIRM ACTION</h3>
        <p id="confirmMessage" class="mb-6"></p>
        <div class="flex justify-end gap-3">
            <button id="btnConfirmCancel" class="neo-btn neo-btn-secondary px-5 py-2">CANCEL</button>
            <button id="btnConfirmAction" class="neo-btn neo-btn-primary px-5 py-2">CONFIRM</button>
        </div>
    </div>
</div>

<div id="modalAddEdit" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30"></div>
    <div class="modal-neumorphic z-50 w-full max-w-lg p-8">
        <h3 id="modalTitle" class="text-3xl font-extrabold mb-6">ADD PART</h3>
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-medium">Category <span class="text-red-500">*</span></label>
                <select id="inpCategory" class="neumorphic-inset w-full"></select>
                <p id="categoryError" class="text-xs mt-1 hidden system-error">Category is required.</p>
            </div>
            <div>
                <label class="block text-sm font-medium">ZOREN No. <span class="text-red-500">*</span></label>
                <input id="inpZoren" class="neumorphic-inset w-full" />
                <p id="zorenError" class="mt-2 hidden system-error">ZOREN No. is required (min 4 chars) and must be alphanumeric/hyphen.</p>
            </div>
            <div>
                <label class="block text-sm font-medium">Car Maker <span class="text-red-500">*</span></label>
                <input id="inpCarMaker" class="neumorphic-inset w-full" />
                <p id="carMakerError" class="mt-2 hidden system-error">Car Maker is required.</p>
            </div>
            <div>
                <label class="block text-sm font-medium">Applications <span class="text-red-500">*</span></label>
                <input id="inpApplications" class="neumorphic-inset w-full" />
                <p id="applicationsError" class="mt-2 hidden system-error">Applications field is required.</p>
            </div>
            <div>
                <label class="block text-sm font-medium">OEM No. (comma separated)</label>
                <input id="inpOem" class="neumorphic-inset w-full" placeholder="31110-09000, E8678M" />
            </div>
        </div>

        <div class="mt-10 flex justify-end gap-3">
            <button id="btnCancelModal" class="neo-btn neo-btn-secondary px-6 py-2.5">CANCEL</button>
            <button id="btnSaveModal" class="neo-btn neo-btn-primary px-6 py-2.5">SAVE PART</button>
            </div>
        </div>
</div>

<div id="modalBulk" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30"></div>
    <div class="modal-neumorphic z-50 w-full max-w-3xl p-8">
        <h3 class="text-3xl font-extrabold mb-6">BULK JSON UPLOAD</h3>
        <p class="text-sm mb-4">Paste JSON array or upload a .json file. Data is validated on upload.</p>

        <div class="space-y-5">
            <div>
                <label class="block text-sm font-medium mb-1">Paste JSON array</label>
                <textarea id="bulkTextarea" rows="8" class="neumorphic-inset w-full font-mono" placeholder='[{"zoren":"ZRM...","oem":["..."],"car_maker":"...","applications":"..."}]'></textarea>
            </div>
            <div id="bulkCategorySelector" class="flex flex-col gap-2 p-5 neumorphic-panel">
                <label class="block text-base font-bold">Category Assignment for uncategorized imports:</label>
                <select id="bulkCategoryInput" class="neumorphic-inset"></select>
            </div>
        </div>

        <div class="mt-8 flex flex-wrap items-center gap-4">
            <input id="bulkFileInput" type="file" accept=".json,application/json" class="text-sm font-semibold" />
            <button id="btnLoadBulk" class="neo-btn neo-btn-secondary px-5 py-2.5">Load & Merge</button>
            <button id="btnReplaceBulk" class="neo-btn neo-btn-primary px-5 py-2.5">REPLACE ALL INVENTORY</button>
            <button id="btnCloseBulk" class="ml-auto neo-btn neo-btn-secondary px-5 py-2.5">CLOSE</button>
        </div>
        </div>
</div>

<div id="modalCategoryManager" class="hidden fixed inset-0 z-40 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-30"></div>
    <div class="modal-neumorphic z-50 w-full max-w-md p-8">
        <h3 class="text-3xl font-extrabold mb-6">CATEGORY MANAGER</h3>
        <div class="space-y-5">
            <div class="flex gap-3">
                <input id="inpNewCategory" class="neumorphic-inset w-full" placeholder="e.g., Brake System" />
                <button id="btnAddCategory" class="neo-btn neo-btn-primary px-5 py-2">ADD</button>
            </div>
            <div id="categoryListContainer" class="max-h-64 overflow-y-auto neumorphic-inset p-4 space-y-3">
                </div>
        </div>
        <div class="mt-8 flex justify-end">
            <button id="btnCloseCategoryManager" class="neo-btn neo-btn-primary px-6 py-2.5">DONE</button>
        </div>
    </div>
</div>

<script type="module">
    // --- FIREBASE IMPORTS (Modern Modular SDK v11.6.1) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, getDoc, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL VARIABLES & INITIALIZATION ---

    // 1. Get configuration from Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // User-provided configuration (must be manually set if __firebase_config is not available)
    const userFirebaseConfig = {
        apiKey: "AIzaSyDMG67OjTem-qRC8S8NN58weeeHnZIGLW0",
        authDomain: "fastway-autospare-parts-shibi.firebaseapp.com",
        projectId: "fastway-autospare-parts-shibi",
        storageBucket: "fastway-autospare-parts-shibi.firebasestorage.app",
        messagingSenderId: "129701229596",
        appId: "1:129701229596:web:ff12c4d0ed2c87ee2d9bd9",
        measurementId: "G-JV6NF5FREJ"
    };

    // Use environment config if available, otherwise use user's explicit config
    const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const firebaseConfig = Object.keys(envConfig).length > 0 ? envConfig : userFirebaseConfig;

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


    // 2. Initialize Firebase App and Services
    let app, auth, db;
    
    // Status update helper
    function updateConnectionStatus(message, isError = false) {
        const logEl = getEl('connectionLog');
        if (logEl) {
            logEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            // Updated color scheme for Neumorphic aesthetic
            logEl.style.color = isError ? 'var(--status-offline)' : 'var(--subtle-text)'; 
        }
    }

    // --- Utility to safely get elements ---
    function getEl(id) {
        return document.getElementById(id);
    }
    
    // --- Security Rules Handler ---
    function displaySecurityRulesError(errorMessage) {
        const rulesInstruction = getEl('rulesInstruction');
        const rulesCode = getEl('rulesCode');

        rulesInstruction.classList.remove('hidden');
        getEl('appContent').classList.remove('hidden');
        getEl('partsContainer').innerHTML = `<p class="text-center text-red-500 p-8 text-xl font-bold">Error: ${errorMessage}. See instructions above.</p>`;
        
        rulesCode.textContent = `
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // This function checks if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // This rule allows authenticated users (anonymous or otherwise)
    // to read and write ONLY within their own user path, 
    // ensuring data privacy.
    match /artifacts/{appId}/users/{userId}/{documents=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}
`;
    }


    // --- Core Initialization Function ---
    async function initApp() {
        updateConnectionStatus("Attempting Firebase initialization...");
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            updateConnectionStatus("Services initialized. Starting authentication check...");
            
            let authResolved = false;
            
            // Set up a promise to resolve when auth state changes (success or fail)
            const authPromise = new Promise(resolve => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    unsubscribe(); // Stop listening after the first state change
                    authResolved = true;
                    resolve(user);
                });
            });

            // Set a timeout to resolve the promise if it takes too long
            const timeoutPromise = new Promise(resolve => 
                setTimeout(() => {
                    if (!authResolved) {
                        updateConnectionStatus("Authentication timed out (5s). Forcing UI visible with error message.", true);
                        resolve(null); // Resolve with null to trigger fallback
                    }
                }, 5000)
            );

            const user = await Promise.race([authPromise, timeoutPromise]);

            if (user) {
                currentUser = user;
                // Updated status pill display
                const authStatusEl = getEl('authStatus');
                authStatusEl.setAttribute('data-status', 'authenticated');
                authStatusEl.innerHTML = `<span class="status-indicator"></span>UID: ${user.uid.substring(0, 8)}... (Authenticated)`;
                getEl('appContent').classList.remove('hidden');
                getEl('btnManageCategories').classList.remove('hidden');
                updateConnectionStatus("Authentication successful. Loading inventory...");
                await loadCategories();
                loadAndRenderParts(); 
            } else {
                // Initial sign-in attempt if no user was found (or timed out)
                await signInUser();

                // If sign-in fails or still times out, display a non-functional state
                if (!currentUser) {
                    const authStatusEl = getEl('authStatus');
                    authStatusEl.setAttribute('data-status', 'auth-fail');
                    authStatusEl.innerHTML = `<span class="status-indicator"></span>AUTH FAIL`;
                    getEl('appContent').classList.remove('hidden');
                    getEl('partsContainer').innerHTML = '<p class="text-center text-red-500 p-8 text-xl font-bold">FATAL ERROR: Could not authenticate or load data. Check console.</p>';
                }
            }
        } catch (error) {
            updateConnectionStatus("FATAL: Initialization failed. See console.", true);
            console.error("Firebase Initialization/Startup Error:", error);
        }
    }

    // --- APP STATE ---
    let parts = [];
    let editIndex = -1;
    let page = 1;
    let perPage = 10;
    let categories = [];
    let currentUser = null; 
    let partsSnapshotUnsubscribe = null;
    const partsContainer = document.getElementById('partsContainer');
    
    // Global function for custom confirmation (replaces window.confirm/alert)
    let confirmResolver;
    
    function showConfirm(title, message, isAlert = false) {
        return new Promise(resolve => {
            confirmResolver = resolve;
            getEl('confirmTitle').textContent = title;
            getEl('confirmMessage').textContent = message
